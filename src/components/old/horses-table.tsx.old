"use client";

import { useState } from "react";
import { useQuery } from "@tanstack/react-query";
import { useHorses } from "@/hooks/use-horses";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { ChevronLeft, ChevronRight } from "lucide-react";

export function HorseTable() {
    const [page, setPage] = useState(1);
    const [search, setSearch] = useState("");
    const [sort, setSort] = useState<{
        field: string;
        direction: "asc" | "desc";
    } | null>(null);

    const pageSize = 10;

    const query = useQuery({
        queryKey: ["horses", page, search, sort],
        queryFn: () =>
            useHorses({
                page,
                pageSize,
                search,
                sort,
            }),
    });

    const horses = query.data?.data?.horses ?? [];

    const toggleSort = (field: string) => {
        setSort((prev) => {
            if (!prev || prev.field !== field) return { field, direction: "asc" };
            if (prev.direction === "asc") return { field, direction: "desc" };
            return null;
        });
    };

    const headers = [
        { key: "name", label: "Name" },
        { key: "status", label: "Status" },
        { key: "age", label: "Age" },
        { key: "discipline.name", label: "Discipline" },
        { key: "category.name", label: "Category" },
        { key: "gender.name", label: "Gender" },
        { key: "height", label: "Height" },
        { key: "price", label: "Price" },
        { key: "location", label: "Location" },
        { key: "user.name", label: "User" }
    ];

    return (
        <div className="space-y-4">
            {/* Search */}
            <Input
                placeholder="Search horses..."
                value={search}
                onChange={(e) => {
                    setSearch(e.target.value);
                    setPage(1);
                }}
                className="w-full"
            />

            {/* Table */}
            <div className="overflow-x-auto rounded-md border">
                <Table>
                    <TableHeader>
                        <TableRow>
                            {headers.map((header) => (
                                <TableHead
                                    key={header.key}
                                    onClick={() => toggleSort(header.key)}
                                    className="cursor-pointer whitespace-nowrap"
                                >
                                    {header.label}
                                    {sort?.field === header.key &&
                                        (sort.direction === "asc" ? " ▲" : " ▼")}
                                </TableHead>
                            ))}
                        </TableRow>
                    </TableHeader>
                    <TableBody>
                        {query.isLoading ? (
                            <TableRow>
                                <TableCell colSpan={headers.length} className="text-center">
                                    Loading...
                                </TableCell>
                            </TableRow>
                        ) : horses.length === 0 ? (
                            <TableRow>
                                <TableCell colSpan={headers.length} className="text-center">
                                    No results found
                                </TableCell>
                            </TableRow>
                        ) : (
                            horses.map((h) => (
                                <TableRow key={h.id}>
                                    <TableCell>{h.name}</TableCell>
                                    <TableCell>{h.status}</TableCell>
                                    <TableCell>{h.age}</TableCell>
                                    <TableCell>{h.discipline.name}</TableCell>
                                    <TableCell>{h.category.name}</TableCell>
                                    <TableCell>{h.gender.name}</TableCell>
                                    <TableCell>{h.height}</TableCell>
                                    <TableCell>{h.price}</TableCell>
                                    <TableCell>{h.location}</TableCell>
                                    <TableCell>{h.user.name}</TableCell>
                                </TableRow>
                            ))
                        )}
                    </TableBody>
                </Table>
            </div>

            {/* Pagination */}
            <div className="flex flex-col sm:flex-row items-center justify-end space-y-2 sm:space-y-0 sm:space-x-2">
                <div className="flex items-center space-x-2">
                    <Button
                        variant="outline"
                        size="sm"
                        onClick={() => setPage((p) => Math.max(1, p - 1))}
                        disabled={page === 1}
                    >
                        <ChevronLeft className="h-4 w-4" />
                    </Button>
                    <span className="text-sm">Page {page}</span>
                    <Button
                        variant="outline"
                        size="sm"
                        onClick={() => setPage((p) => p + 1)}
                        disabled={horses.length < pageSize}
                    >
                        <ChevronRight className="h-4 w-4" />
                    </Button>
                </div>
            </div>
        </div>
    );
}
